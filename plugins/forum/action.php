<?phpinclude_once "../../class.php";include_once (HEADERF);$mode = isset($_GET['mode']) ? $_GET['mode'] : '';//----------------------------------------------------------------------------------------------------------------------------------//if(isset($_POST["new_cat"])){	if(isset($_POST['name'], $_POST['description']) and $_POST['name']!='')	{		$name = $_POST['name'];		$description = $_POST['description'];		if(get_magic_quotes_gpc())		{			$name = stripslashes($name);			$description = stripslashes($description);		}		$name = mysql_real_escape_string($name);		$description = mysql_real_escape_string($description);		$qry_id = 'SELECT * FROM #categories ORDER BY id DESC LIMIT 1';		$sql -> db_Select_gen($qry_id);		$result_id = $sql -> db_Fetch();		$result_id = $result_id['id']+1;		$qry = 'INSERT INTO #categories				(id, name, description, position)				VALUES ("'.$result_id.'", "'.$name.'", "'.$description.'", "'.($result_id).'")';		if($sql2 -> db_Select_gen($qry))		{			echo'			<div class="message">категорията е създадена успешно.<br />			<a href="'.e_PLUGINS.'forum/">Обратно към форума</a></div>			';		}		else		{			echo 'Грешка при създаване на категорията.';		}	}}//----------------------------------------------------------------------------------------------------------------------------------//if(isset($_POST["edit_cat"])){	$id = intval($_GET['id']);	if(isset($_POST['name'], $_POST['description']) and $_POST['name']!='')	{		$name = $_POST['name'];		$description = $_POST['description'];		if(get_magic_quotes_gpc())		{			$name = stripslashes($name);			$description = stripslashes($description);		}		$name = mysql_real_escape_string($name);		$description = mysql_real_escape_string($description);		echo $name;		if($sql -> db_Select_gen("update #categories set name='".$name."', description='".$description."' where id='".$id."'"))		{			echo'				<div class="message">Категорията е редактирана успешно.<br />				<a href="'.e_PLUGINS.'forum/">Обратно към форума</a></div>						';		}		else		{			echo 'Грешка при редакция на категорията.';		}	}}//----------------------------------------------------------------------------------------------------------------------------------//if(isset($_POST["del_cat"])){	$id = intval($_GET['id']);	$qry = 'SELECT COUNT(id)			AS nb1, name, position			FROM #categories			WHERE id="'.$id.'"			GROUP BY id';	$sql -> db_Select_gen($qry);	$dn1 = $sql -> db_Fetch();	echo $dn1['position'];	if(isset($_SESSION['user_id']) and $_SESSION['user_id'] == 1)	{		$qry1 = 'DELETE FROM #categories WHERE id="'.$id.'"';		$qry2 = 'DELETE FROM #topics WHERE parent="'.$id.'"';		$qry3 = 'UPDATE #categories SET position=position-1 where position>"'.$dn1['position'].'"';		if($sql2 -> db_Select_gen($qry1) and $sql2 -> db_Select_gen($qry2) and $sql2 -> db_Select_gen($qry3))		{			echo'			<div class="message">Категорията успешно е изтрита.<br />			<a href="'.e_PLUGINS.'forum/">Обратно към форума</a></div>			';		}		else		{			echo 'Грешка при триене на категорията и постовете й.';		}	}}//----------------------------------------------------------------------------------------------------------------------------------//if(isset($_POST["new_topic"])){	$id = intval($_GET['parent']);	if(isset($_POST['message'], $_POST['title']) and $_POST['message']!='' and $_POST['title']!='')	{		$title = $_POST['title'];		$message = $_POST['message'];		if(get_magic_quotes_gpc())		{			$title = stripslashes($title);			$message = stripslashes($message);		}		$title = mysql_real_escape_string($title);		$message = mysql_real_escape_string(bbcode_to_html($message));		$qry_id = 'SELECT * FROM #topics ORDER BY id DESC LIMIT 1';		$sql -> db_Select_gen($qry_id);		$result_id = $sql -> db_Fetch();		$result_id = $result_id['id'] +1;		$qry = 'INSERT INTO #topics		(parent, id, id2, title, message, authorid, timestamp, timestamp2)		VALUES		("'.$id.'", "'.$result_id.'", 1, "'.$title.'", "'.$message.'", "'.$_SESSION['user_id'].'", "'.time().'", "'.time().'")';		if($sql -> db_Select_gen($qry))		{			echo'			<div class="message">Темата е създадена успешно.<br />			<a href="list_topics.php?parent='.$id.'">Обратно към форума</a></div>			<br />			';			require_once (FOOTERF);		}		else		{			echo 'Грешка при създаване на темата.';		}	}	else	{		echo'<div class="message">Моля, попълнете всички полета!.<br />';		echo'<input type="button" value="Обратно" onclick="javascript:history.go(-1);" />';	}}//----------------------------------------------------------------------------------------------------------------------------------//if(isset($_POST["del_topic"])){	$id = intval($_GET['id']);	$qry = 'SELECT COUNT(t.id)			AS nb1, t.title, t.parent, c.name			FROM #topics			AS t, #categories			AS c where t.id="'.$id.'" and t.id2=1 AND c.id=t.parent			GROUP BY t.id';	$sql -> db_Select_gen($qry);	$dn1 = $sql -> db_Fetch();	$qry1 = 'DELETE FROM #topics WHERE id="'.$id.'"';	if($sql2 -> db_Select_gen($qry1))	{		echo'		<div class="message">Темата е изтрита успешно.<br />		<a href="list_topics.php?parent='.$dn1["parent"].'">Обратно към "'.htmlentities($dn1["name"], ENT_QUOTES, "UTF-8").'"</a></div>		<br />		';		require_once (FOOTERF);	}	else	{		echo 'Грешка при триене на темата.';	}}//----------------------------------------------------------------------------------------------------------------------------------//if(isset($_POST["new_reply"])){	$id = intval($_GET['id']);	$qry = 'SELECT COUNT(t.id)	AS nb1, t.title, t.parent, c.name	from #topics	AS t, #categories	AS c WHERE t.id="'.$id.'" and t.id2=1 and c.id=t.parent	GROUP BY t.id';	$sql -> db_Select_gen($qry);	$dn1 = $sql -> db_Fetch();	if(isset($_POST['message']) and $_POST['message']!='')	{		$message = $_POST['message'];		if(get_magic_quotes_gpc())		{			$message = stripslashes($message);		}		$message = mysql_real_escape_string(bbcode_to_html($message));		$qry1 = 'INSERT INTO #topics		(parent, id, id2, title, message, authorid, timestamp, timestamp2)		SELECT "'.$dn1['parent'].'", "'.$id.'", max(id2)+1, "", "'.$message.'", "'.$_SESSION['user_id'].'", "'.(time()+60*60).'", "'.(time()+60*60).'"		FROM #topics		WHERE id="'.$id.'"';		$qry2 = 'UPDATE #topics		SET timestamp2="'.(time()+60*60).'"		WHERE id="'.$id.'" and id2=1';		$sql3 = new db;		$qry3 = 'UPDATE #categories SET last_timestamp="'.(time()+60*60).'" WHERE id="'.$dn1['parent'].'"';		$sql3 -> db_Select_gen($qry3);				if($sql -> db_Select_gen($qry1) and $sql2 -> db_Select_gen($qry2))		{			echo'			<div class="message">Съобщението е изпратено успешно.<br />			<a href="read_topic.php?id='.$id.'">Обратно към темата</a></div>			<br />			';			require_once (FOOTERF);		}		else		{			echo 'Грешка при изпращане на съобщението.';		}	}}//----------------------------------------------------------------------------------------------------------------------------------//if(isset($_POST["edit_message"])){	$id = intval($_GET['id']);	$id2 = intval($_GET['id2']);	$qry = 'select count(t.id)			as nb1, t.authorid, t2.title, t.message, t.parent, c.name			from #topics			as t, #topics			as t2, #categories			as c			where t.id="'.$id.'" and t.id2="'.$id2.'" and t2.id="'.$id.'" and t2.id2=1 and c.id=t.parent			group by t.id';	$sql -> db_Select_gen($qry);	$dn1 = $sql -> db_Fetch();	if(isset($_POST['message']) and $_POST['message']!='')	{		if($id2==1)		{			if(isset($_POST['title']) and $_POST['title']!='')			{				$title = $_POST['title'];				if(get_magic_quotes_gpc())				{					$title = stripslashes($title);				}				$title = mysql_real_escape_string($title);			}			else			{				$title = mysql_real_escape_string($dn1['title']);			}		}		else		{			$title = '';		}		$message = $_POST['message'];		if(get_magic_quotes_gpc())		{			$message = stripslashes($message);		}		$message = mysql_real_escape_string(bbcode_to_html($message));		$qry = 'update #topics				set title="'.$title.'", message="'.$message.'" where id="'.$id.'" and id2="'.$id2.'"';		if($sql -> db_Select_gen($qry))		{			echo'			<div class="message">Съобщението е редактирано успешно.<br />			<a href="read_topic.php?id='.$id.'">Обратно към темата</a></div>			';		}		else		{			echo 'Грешка при редакция на съобщението.';		}	}	else	{		echo'<div class="message">Моля, попълнете всички полета!.<br />';		echo'<input type="button" value="Обратно" onclick="javascript:history.go(-1);" />';	}	echo '<br />';	require_once(FOOTERF);}//----------------------------------------------------------------------------------------------------------------------------------////===============================================================================================================================//if ($mode == "new_cat"){	if(USERID and USERLV == ADMIN_LEVEL)	{		echo'		<h1 class="red">Създаване на Категория</h1>		<div class="content_pm">			<form action="'.htmlentities($_SERVER['PHP_SELF'], ENT_QUOTES).'" method="post">				<label for="name">Име</label><input type="text" name="name" id="name" /><br />				<label for="description">Описание</label><br />				<textarea name="description" id="description" cols="70" rows="6"></textarea><br />				<input type="submit" value="Създай" name="new_cat"/>			</form>		</div>		<br />		';	}	else	{		echo '<h2>Трябва да си администратор за да ползваш тази страница!</h2>';		require_once (FOOTERF);		exit;	}		require_once(FOOTERF);}//===============================================================================================================================//if ($mode == "move_cat"){	if(isset($_GET['id'], $_GET['action']) and ($_GET['action']=='up' or $_GET['action']=='down'))	{		$id = intval($_GET['id']);		$action = $_GET['action'];				$qry = 'SELECT COUNT(c.id)				AS nb1, c.position, COUNT(c2.id)				AS nb2 from #categories				AS c, #categories				AS c2 where c.id="'.$id.'"				GROUP BY c.id';		$sql -> db_Select_gen($qry);		$dn1 = $sql -> db_Fetch();				if($dn1['nb1']>0)		{			if(USERID and USERLV == ADMIN_LEVEL)			{				if($action=='up')				{					if($dn1['position']>1)					{						$qry = 'UPDATE #categories								as c, #categories								as c2								SET c.position=c.position-1, c2.position=c2.position+1								WHERE c.id="'.$id.'" and c2.position=c.position-1';						if($sql2 -> db_Select_gen($qry))						{							header('Location: '.e_PLUGINS.'forum/');						}						else						{							echo 'An error occured while moving the category.';						}					}					else					{						echo '<h2>The action you want to do is impossible (up).</h2>';					}				}				else				{					if($dn1['position']<$dn1['nb2'])					{						$qry = 'UPDATE #categories								AS c, #categories								AS c2								SET c.position=c.position+1, c2.position=c2.position-1								WHERE c.id="'.$id.'" AND c2.position=c.position+1';						if($sql -> db_Select_gen($qry))						{							header('Location: '.e_PLUGINS.'forum/');						}						else						{							echo 'An error occured while moving the category.';						}					}					else					{						echo '<h2>The action you want to do is impossible (down).</h2>';					}				}			}			else			{				echo '<h2>You must be logged as an administrator to access this page: <a href="login.php">Login</a> - <a href="signup.php">Sign Up</a></h2>';			}		}		else		{			echo '<h2>The category you want to move doesn\'t exist.</h2>';		}	}	else	{		echo '<h2>The ID of the category you want to move is not defined.</h2>';	}}//===============================================================================================================================//if ($mode == "edit_cat"){	$id = intval($_GET['id']);	$sql -> db_Select_gen("select count(id) as nb1, name, description from #categories where id='".$id."' group by id");	$dn1 = $sql -> db_Fetch();	if(USERID and USERLV == ADMIN_LEVEL)	{		echo'		<h1 class="red">Промяна на Категория</h1>		<div class="content_pm">			<form action="'.htmlentities($_SERVER['PHP_SELF'], ENT_QUOTES).'?id='.$id.'" method="post">				<label for="name">Име</label><input type="text" name="name" id="name" value="'.htmlentities($dn1["name"], ENT_QUOTES, "UTF-8").'" /><br />				<label for="description">Описание</label>(HTML вкл.)<br />				<textarea name="description" id="description" cols="70" rows="6">'.htmlentities($dn1["description"], ENT_QUOTES, "UTF-8").'</textarea><br />				<input type="submit" value="Промени" name="edit_cat"/>			</form>		</div>		';	}}//===============================================================================================================================//if ($mode == "del_cat"){	$id = intval($_GET['id']);	echo'		<h1 class="red">Изтриване на Категория</h1>		<div class="content_pm" style="text-align:center;">			<form action="'.htmlentities($_SERVER['PHP_SELF'], ENT_QUOTES).'?id='.$id.'" method="post">				Сигурен ли си, че искаш да изтриеш категорията и всички теми в нея?				<br /><br />				<input type="hidden" name="confirm" value="true" />				<input type="submit" value="Да" name="del_cat" />				<input type="button" value="Не" onclick="javascript:history.go(-1);" autofocus />			</form>		</div>		<br />	';		require_once(FOOTERF);}//===============================================================================================================================//if ($mode == "new_topic"){	$id = intval($_GET['parent']);	echo'		<script type="text/javascript" src="functions.js"></script>		<h1 class="red">Нова Тема</h1>		<div class="content_pm">			<form action="'.htmlentities($_SERVER['PHP_SELF'], ENT_QUOTES).'?parent='.$id.'" method="post">				<label for="title">Заглавие</label><input type="text" name="title" id="title" /><br />				<label for="message">Съобщение</label><br />';				if($pref['wysiwyg'])				{					$editor_class = "useTM";				}				else				{					$editor_class = "";					echo'					<div class="message_buttons">						<input type="button" value="Bold" onclick="javascript:insert(\'[b]\', \'[/b]\', \'message\');" /><!--						--><input type="button" value="Italic" onclick="javascript:insert(\'[i]\', \'[/i]\', \'message\');" /><!--						--><input type="button" value="Underlined" onclick="javascript:insert(\'[u]\', \'[/u]\', \'message\');" /><!--						--><input type="button" value="Image" onclick="javascript:insert(\'[img]\', \'[/img]\', \'message\');" /><!--						--><input type="button" value="Link" onclick="javascript:insert(\'[url]\', \'[/url]\', \'message\');" /><!--						--><input type="button" value="Left" onclick="javascript:insert(\'[left]\', \'[/left]\', \'message\');" /><!--						--><input type="button" value="Center" onclick="javascript:insert(\'[center]\', \'[/center]\', \'message\');" /><!--						--><input type="button" value="Right" onclick="javascript:insert(\'[right]\', \'[/right]\', \'message\');" />					</div>';				}				echo'				<textarea class="'.$editor_class.'" name="message" id="message" cols="70" rows="6"></textarea><br />				<input type="submit" value="Изпрати" name="new_topic" />			</form>		</div>		<br />	';	require_once(FOOTERF);}//===============================================================================================================================//if ($mode == "del_topic"){	$id = intval($_GET['id']);	echo'	<h1 class="red">Изтриване на Тема</h1>	<div class="content_pm center">		<form action="'.htmlentities($_SERVER['PHP_SELF'], ENT_QUOTES).'?id='.$id.'" method="post">			Сигурен ли си, че искаш да изтриеш темата?			<br /><br />			<input type="hidden" name="confirm" value="true" />			<input type="submit" value="Да" name="del_topic" />			<input type="button" value="Не" onclick="javascript:history.go(-1);" autofocus />		</form>	</div>	<br />	';	require_once(FOOTERF);}//===============================================================================================================================//if ($mode == "new_reply"){	$id = intval($_GET['id']);	echo'	<script type="text/javascript" src="functions.js"></script>	<h1 class="red">Писане на Отговор</h1>	<div class="content_pm center">		<form action="'.htmlentities($_SERVER['PHP_SELF'], ENT_QUOTES).'?id='.$id.'" method="post">';			if($pref['wysiwyg'])				{					$editor_class = "useTM";				}				else				{					$editor_class = "";					echo'					<div class="message_buttons">						<input type="button" value="Bold" onclick="javascript:insert(\'[b]\', \'[/b]\', \'message\');" /><!--						--><input type="button" value="Italic" onclick="javascript:insert(\'[i]\', \'[/i]\', \'message\');" /><!--						--><input type="button" value="Underlined" onclick="javascript:insert(\'[u]\', \'[/u]\', \'message\');" /><!--						--><input type="button" value="Image" onclick="javascript:insert(\'[img]\', \'[/img]\', \'message\');" /><!--						--><input type="button" value="Link" onclick="javascript:insert(\'[url]\', \'[/url]\', \'message\');" /><!--						--><input type="button" value="Left" onclick="javascript:insert(\'[left]\', \'[/left]\', \'message\');" /><!--						--><input type="button" value="Center" onclick="javascript:insert(\'[center]\', \'[/center]\', \'message\');" /><!--						--><input type="button" value="Right" onclick="javascript:insert(\'[right]\', \'[/right]\', \'message\');" />					</div>';				}				echo'			<textarea name="message" class="useTM" id="message" cols="70" rows="10"></textarea><br />			<input type="submit" value="Изпрати" name="new_reply"/>		</form>	</div>	<br />	';		require_once (FOOTERF);}//===============================================================================================================================//if ($mode == "edit_message"){	$id = intval($_GET['id']);	$id2 = intval($_GET['id2']);	$qry = 'select count(t.id)			as nb1, t.authorid, t2.title, t.message, t.parent, c.name			from #topics			as t, #topics			as t2, #categories			as c			where t.id="'.$id.'" and t.id2="'.$id2.'" and t2.id="'.$id.'" and t2.id2=1 and c.id=t.parent			group by t.id';	$sql -> db_Select_gen($qry);	$dn1 = $sql -> db_Fetch();	if(USERID == $dn1['authorid'] or USERLV == ADMIN_LEVEL)	{		echo'<h1 class="red">Редакция на Тема</h1>			<div class="content_pm center">			<form action="'.htmlentities($_SERVER['PHP_SELF'], ENT_QUOTES).'?id='.$id.'&id2='.$id2.'" method="post">';			if(USERID == 1 and $id2==1)			{				echo'<label for="title">Заглавие</label><input type="text" name="title" id="title" value="'.htmlentities($dn1["title"], ENT_QUOTES, "UTF-8").'" />';			}			echo'			<script type="text/javascript" src="functions.js"></script>			<div class="message_buttons">				<input type="button" value="Bold" onclick="javascript:insert(\'[b]\', \'[/b]\', \'message\');" /><!--				--><input type="button" value="Italic" onclick="javascript:insert(\'[i]\', \'[/i]\', \'message\');" /><!--				--><input type="button" value="Underlined" onclick="javascript:insert(\'[u]\', \'[/u]\', \'message\');" /><!--				--><input type="button" value="Image" onclick="javascript:insert(\'[img]\', \'[/img]\', \'message\');" /><!--				--><input type="button" value="Link" onclick="javascript:insert(\'[url]\', \'[/url]\', \'message\');" /><!--				--><input type="button" value="Left" onclick="javascript:insert(\'[left]\', \'[/left]\', \'message\');" /><!--				--><input type="button" value="Center" onclick="javascript:insert(\'[center]\', \'[/center]\', \'message\');" /><!--				--><input type="button" value="Right" onclick="javascript:insert(\'[right]\', \'[/right]\', \'message\');" />			</div>			<textarea name="message" id="message" cols="70" rows="15">'.html_to_bbcode($dn1["message"]).'</textarea><br />			<input type="submit" value="Изпрати" name="edit_message" />		</form>		</div>		<br />		';				require_once(FOOTERF);	}	else	{		echo '<h2>You don\'t have the right to edit this message.</h2>';	}}?>